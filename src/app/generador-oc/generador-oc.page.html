<ion-header [translucent]="true">
  <ion-toolbar style="--background: red; color: white;">
    <ion-buttons slot="start" style="color: white;">
      <ion-back-button color="light" defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-title>Generador OC</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-card>
    <ion-card-header>
      <ion-card-title color="primary">Subir Cotizaci√≥n</ion-card-title>
    </ion-card-header>

    <ion-card-content>

      <!-- N√∫mero OC -->
      <ion-item>
        <ion-label>N√∫mero de Cotizaci√≥n</ion-label>
        <ion-input [value]="nuevoIdVisual" readonly></ion-input>
      </ion-item>

      <!-- Checkbox para usar SOLPED -->
      <ion-item lines="none">
        <ion-label>¬øAsociar a una SOLPED?</ion-label>
        <ion-checkbox [(ngModel)]="usarSolped" slot="end" (ionChange)="onToggleUsarSolped()"></ion-checkbox>
      </ion-item>


      <!-- Selector de SOLPED -->
      <ng-container *ngIf="usarSolped">
        <ion-item>
          <ion-label position="floating">SOLPED asociada</ion-label>
          <ion-select [(ngModel)]="solpedSeleccionadaId" (ionChange)="onChangeSolped()" required>
            <ion-select-option *ngFor="let solpe of solpedDisponibles" [value]="solpe.id">
              #{{ solpe.numero_solpe }} - {{ solpe.nombre_solped }} ({{ solpe.tipo_solped }}) - {{ solpe.nombre_centro_costo }} - {{ solpe.usuario || 'Sin usuario' }} - {{ solpe.empresa || 'Sin empresa' }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Mostrar info de la SOLPED seleccionada -->
        <ion-item *ngIf="solpedSeleccionada">
          <ion-label>
            <strong>N¬∞ Solped:</strong><br />
            {{ solpedSeleccionada.numero_solpe }}
          </ion-label>
        </ion-item>
        <ion-item *ngIf="solpedSeleccionada">
          <ion-label>
            <strong>Centro de Costo:</strong><br />
            {{ solpedSeleccionada.numero_contrato }} - {{ solpedSeleccionada.nombre_centro_costo }}
          </ion-label>
        </ion-item>
        <ion-item *ngIf="solpedSeleccionada">
          <ion-label>
            <strong>Empresa:</strong><br />
            {{ solpedSeleccionada.empresa }}
          </ion-label>
        </ion-item>
        <ion-item *ngIf="solpedSeleccionada">
          <ion-label>
            <strong>Tipo de SOLPED:</strong><br />
            {{ solpedSeleccionada.tipo_solped }}
          </ion-label>
        </ion-item>

        <ion-item *ngIf="solpedSeleccionada">
          <ion-label>
            <strong>Nombre SOLPED:</strong><br />
            {{ solpedSeleccionada.nombre_solped }}
          </ion-label>
        </ion-item>

        <!-- √çtems de la SOLPED -->
        <ion-card *ngIf="itemsSolped.length > 0">
          <ion-card-header>
            <ion-card-title>üì¶ √çtems de la SOLPED</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <ion-item *ngFor="let item of itemsSolped">
                <ion-label class="ion-text-wrap">
                  <h3>{{ item.descripcion }}</h3>
                  <p>
                    Cantidad Total: {{ item.cantidad }} <br>
                    Cotizado antes: {{ item.cantidad_cotizada || 0 }}
                  </p>
                  <ion-input
                    type="number"
                    placeholder="Cantidad a cotizar"
                    min="0"
                    [max]="item.cantidad - item.cantidad_cotizada"
                    [(ngModel)]="item.cantidad_para_cotizar">
                  </ion-input>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </ng-container>
      <ion-item>
        <ion-label position="floating">Centro de Costo</ion-label>
        <ion-input
          [value]="nombreCentroCosto || ''"
          placeholder="Selecciona un centro‚Ä¶"
          readonly
          (click)="openCentro($event)">
        </ion-input>
      </ion-item>

      <ion-popover
        [isOpen]="isCentroOpen"
        [event]="centroEvent"
        (didDismiss)="isCentroOpen = false"
        cssClass="popover-centro"
        showBackdrop="true">
        <ng-template>
          <ion-content class="ion-padding">
            <ion-header collapse="condense" class="ion-no-border">
              <ion-toolbar>
                <ion-title>Selecciona Centro de Costo</ion-title>
                <ion-buttons slot="end">
                  <ion-button (click)="isCentroOpen = false">Cerrar</ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-header>

            <ion-searchbar
              placeholder="Buscar contrato o c√≥digo‚Ä¶"
              [(ngModel)]="filtroCentro"
              (ionInput)="filtrarCentros()"
              debounce="150">
            </ion-searchbar>

            <ion-list>
              <ion-item
                button
                *ngFor="let c of centrosFiltrados; let i = index"
                (click)="seleccionarCentro(c)">
                <ion-label class="ion-text-wrap">
                  <div><strong>{{ c.key }}</strong></div>
                  <div>{{ c.name }}</div>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-content>
        </ng-template>
      </ion-popover>
      <ion-item>
        <ion-label position="floating">N¬∞ Patente/ Stock</ion-label>
        <ion-select [(ngModel)]="tipoCompra" interface="popover" required>
          <ion-select-option value="stock">Stock</ion-select-option>
          <ion-select-option value="patente">Patente</ion-select-option>
        </ion-select>
      </ion-item>
      <ion-item *ngIf="tipoCompra === 'patente'">
        <ion-input [(ngModel)]="destinoCompra" placeholder="Escribe la patente aqu√≠"></ion-input>
      </ion-item>
      <ion-item>
      <ion-label position="floating">Moneda</ion-label>
        <ion-select [(ngModel)]="monedaSeleccionada">
          <ion-select-option value="CLP">CLP</ion-select-option>
          <ion-select-option value="USD">USD</ion-select-option>
          <ion-select-option value="EUR">EUR</ion-select-option>
          <ion-select-option value="UF">UF</ion-select-option>
        </ion-select>
    </ion-item>
      <ion-item>
        <ion-label position="floating">Precio Total con IVA</ion-label>
        <ion-input
          type="text"
          [value]="precioFormateado"
          (ionInput)="formatearPrecio($event)"
          required
        ></ion-input>
      </ion-item>
      <ion-item *ngIf="aprobadorSugerido">
        <ion-label>
          <strong>Aprobador sugerido:</strong> {{ aprobadorSugerido }}
        </ion-label>
      </ion-item>

      <ion-item>
        <ion-label position="floating">Comentario</ion-label>
        <ion-textarea [(ngModel)]="comentario" placeholder="Agrega un comentario opcional..."></ion-textarea>
      </ion-item>

      <ion-item>
        <ion-label>Archivos PDF o Imagen (Se puede subir m√°s PDF)</ion-label>
        <input
          id="inputArchivo"
          type="file"
          multiple
          accept="application/pdf,image/*"
          style="display: none"
          (change)="onMultipleFilesSelected($event)"
        />
        <ion-button expand="block" (click)="abrirSelectorArchivos()">Seleccionar Archivos</ion-button>

      </ion-item>
      <!-- AUTORIZACI√ìN ADJUNTA -->
      <ion-card *ngIf="usarSolped && solpedSeleccionada && autorizacionUrlRaw">
        <ion-card-header>
          <ion-card-title>üìé Autorizaci√≥n adjunta</ion-card-title>
          <ion-note *ngIf="autorizacionNombre" class="ion-text-wrap">
            {{ autorizacionNombre }}
          </ion-note>
          <ion-chip *ngIf="autorizacionExt" color="medium" class="ion-margin-top">
            <ion-label>.{{ autorizacionExt }}</ion-label>
          </ion-chip>
        </ion-card-header>

        <ion-card-content>
          <!-- Preview PDF -->
          <ng-container *ngIf="autorizacionEsPDF">
            <iframe
              [src]="autorizacionSafeUrl"
              width="100%"
              height="500"
              style="border:none;"
            ></iframe>
          </ng-container>

          <!-- Preview Imagen -->
          <ng-container *ngIf="!autorizacionEsPDF && autorizacionEsImagen">
            <div style="display:flex;justify-content:center;align-items:center;">
              <img
                [src]="autorizacionSafeUrl"
                alt="Autorizaci√≥n"
                style="max-width:100%; max-height:500px; border-radius:12px; object-fit:contain;"
              />
            </div>
          </ng-container>

          <!-- Sin preview (XLS/XLSX/DOC, etc.) -->
          <ion-item lines="none" *ngIf="!autorizacionEsPDF && !autorizacionEsImagen">
            <ion-icon name="document-attach-outline" slot="start"></ion-icon>
            <ion-label class="ion-text-wrap">
              Este archivo no se puede previsualizar aqu√≠. Puedes abrirlo o descargarlo.
            </ion-label>
          </ion-item>

          <div class="ion-margin-top" style="display:flex; gap:.5rem; flex-wrap:wrap;">
            <ion-button fill="outline" [href]="autorizacionUrlRaw" target="_blank" rel="noopener">
              Ver en otra pesta√±a
            </ion-button>
            <a
              [href]="autorizacionUrlRaw"
              [attr.download]="autorizacionNombre || 'autorizacion'"
              style="text-decoration:none"
            >
              <ion-button>
                Descargar
              </ion-button>
            </a>
          </div>
        </ion-card-content>
      </ion-card>
      <!-- Vista previa del archivo -->
      <ion-card *ngFor="let archivo of archivos; let i = index">
        <ion-card-header class="ion-align-items-center ion-justify-content-between">
          <ion-card-title>{{ archivo.name }}</ion-card-title>
          <ion-button
            fill="clear"
            color="danger"
            size="small"
            (click)="eliminarArchivo(i)"
            style="margin-left: auto;"
          >
            <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-card-header>

        <ion-card-content>
          <ng-container *ngIf="archivo.tipo?.includes('pdf'); else mostrarImagen">
            <iframe
              *ngIf="archivo.previewUrl"
              [src]="archivo.previewUrl"
              width="100%"
              height="400px"
              style="border: none;"
            ></iframe>
          </ng-container>

          <ng-template #mostrarImagen>
            <div style="display: flex; justify-content: center; align-items: center; padding: 10px;">
              <img
                *ngIf="archivo.previewUrl"
                [src]="archivo.previewUrl"
                alt="Vista previa"
                style="max-width: 100%; max-height: 700px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); object-fit: contain;"
              />
            </div>
          </ng-template>
        </ion-card-content>
      </ion-card>

      <!-- Bot√≥n de env√≠o -->
      <ion-button expand="block" style="--background: red; color: white;" (click)="enviarOC()" [disabled]="enviando">
        Enviar Cotizaci√≥n
      </ion-button>

    </ion-card-content>
  </ion-card>
</ion-content>
